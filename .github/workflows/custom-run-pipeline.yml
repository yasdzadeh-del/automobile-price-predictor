name: run-pipeline

on:
  workflow_call:
    inputs:
      parameters-file:
        required: true
        type: string
      resource_group:
        required: true
        type: string
      workspace_name:
        required: true
        type: string
      job-name:
        required: true
        type: string
    secrets:
      creds:
        required: true

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: "Az CLI login"
        uses: azure/login@v1
        with:
          creds: ${{ secrets.creds }}

      - name: install-extension
        run: az extension add -n ml -y

      - name: run-ml-pipeline
        shell: bash
        run: |
          # Use absolute path from workspace root
          FILE_PATH="${{ github.workspace }}/${{ inputs.parameters-file }}"
          
          echo "Starting ML Job using file: $FILE_PATH"
          
          run_id=$(az ml job create --file "$FILE_PATH" --resource-group ${{ inputs.resource_group }} --workspace-name ${{ inputs.workspace_name }} --query name -o tsv)
          
          if [[ -z "$run_id" ]]; then
            echo "Error: Job creation failed"
            exit 3
          fi
          
          echo "Job started with ID: $run_id"
          
          # Monitoring loop
          while true; do
            status=$(az ml job show -n $run_id --resource-group ${{ inputs.resource_group }} --workspace-name ${{ inputs.workspace_name }} --query status -o tsv)
            echo "Current Status: $status"
            
            case "$status" in
              "Completed")
                echo "Job finished successfully"
                exit 0
                ;;
              "Failed"|"Canceled")
                echo "Job failed or was canceled"
                exit 3
                ;;
              *)
                # Still running
                sleep 30
                ;;
            esac
          done